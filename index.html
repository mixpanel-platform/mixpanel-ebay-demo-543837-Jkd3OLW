<!doctype html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
      <div id="dateSelect" style="float: right;"></div>
      <div style="clear: both;"></div>
      <div id="graphSelect" style="float: right;"></div>
      <div id="graph"></div>
    </div>
    <div id="table"></div>
    <script>
      MP.api.ready(function() {
        
        var dateSelect  = $('#dateSelect').MPDatepicker();

        var runQuery = function() {
          var eventName = "Bid Placed",
              propName  = "Gender",
              dateRange = dateSelect.MPDatepicker('value');
          
          var series = [{
            name: 'Bids',
            yAxis: 0,
            data: [],
          }, {
            name: 'Wins',
            yAxis: 1,
            data: [],
          }];
          
          var promiselist = []
              
          promiselist.push(MP.api.segment(eventName, propName, dateRange).done(function(results) {
            return results.values();
          }));
          
          var eventName = "Item Won";
          promiselist.push(MP.api.segment(eventName, propName, dateRange).done(function(results) {
            return results.values();
          }));
          
          Promise.all(promiselist).then(function(promiseArray){
            for(i=0; i<promiseArray.length; i++) {
              console.log(promiseArray[i].values()['Male']);
              var tempdata = [];
              var axiskeys = [];
              var keys = Object.keys(promiseArray[i].values()['Male']);
              for(j=0; j<keys.length; j++) {
                if(j==0) {  axiskeys.push(keys[j]); }
                tempdata[j].push(promiseArray[i].values()['Male'][keys[j]]);
              }
            }
            
            var dualAxis = {
              xAxis: [
                {
                  categories: axiskeys
                }
              ],
              yAxis: [
                { // Primary yAxis 
                  title: { 
                    text: 'Bids' 
                  }, 
                  min: 0 
                }, 
              { // Secondary yAxis 
                  title: { 
                    text: 'Ratio' 
                  }, 
                  opposite: true, 
                  min:0 
                }
              ], 
              tooltip: { 
                shared: true 
              },
              series: [
                {
                  name: 'Bids',
                  type: 'line',
                  yAxis: 0,
                  data: tempdata[0]
                }, {
                  name: 'Wins',
                  type: 'line',
                  data: tempdata[1],
                }
              ]
            };
            
            var eventGraph  = $('#graph').MPChart({chartType: 'line', highchartsOptions: dualAxis});
          });
          
        };
        
        dateSelect.on('change', runQuery);
        
        runQuery();
        
      });
    </script>
  </body>
</html>